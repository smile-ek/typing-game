<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°æ¤œå®š</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .word, .romaji, #result, #questionCounter {
            font-size: 20px;
            margin: 10px 0;
            display: none;
        }
        .romaji span {
            letter-spacing: 5px;
        }
        .correct {
            color: green;
        }
        #gradeButtons {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2åˆ—ã«è¨­å®š */
            gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            justify-content: center; /* ä¸­å¤®å¯„ã› */
            max-width: 300px; /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’åˆ¶é™ï¼ˆèª¿æ•´å¯èƒ½ï¼‰ */
            margin: auto; /* ä¸­å¤®é…ç½® */
        }
        #gradeButtons button {
            width: 140px; /* å¹…ã‚’çµ±ä¸€ */
            height: 50px; /* é«˜ã•ã‚’çµ±ä¸€ */
            font-size: 18px;
            text-align: center;
            border: 2px solid black;
            background-color: #ffffff;
            color: black;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #gradeButtons button:hover {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }

        #romajiDisplay {
            height: 70px; /* ã“ã“ã§é«˜ã•ã‚’å›ºå®š */
            font-size: 18px; /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’é©åº¦ã«èª¿æ•´ */
            word-break: break-word; /* å˜èªã®é€”ä¸­ã§ã‚‚æ”¹è¡Œ */
            white-space: normal; /* ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ã‚Œã‚‹ã‚ˆã†ã« */
            max-width: 100%; /* è¦ªè¦ç´ ã®å¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã« */
            display: block;
        }
        #wordContainer {
            height: 140px; /* ã“ã“ã§é«˜ã•ã‚’å›ºå®š */
            display: flex;
            align-items: center; /* ä¸Šä¸‹ã®ä¸­å¤®æƒãˆ */
            justify-content: center;
            text-align: center;
        }
        #wordDisplay {
            text-align: center;
            white-space: pre-wrap; /* è‡ªå‹•æ”¹è¡Œã‚’è¨±å¯ */
        }
        #kanjiDisplay {
            font-size: 25px;
            font-weight: bold;
            color: black;
            height: 85px; /* æ¼¢å­—ã‚¨ãƒªã‚¢ã®é«˜ã•å›ºå®š */
            display: flex;
            align-items: center; /* ç¸¦æ–¹å‘ã‚’ä¸Šå¯„ã› */
            justify-content: center; /* æ¨ªæ–¹å‘ã®ä¸­å¤®å¯„ã› */
            text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­å¤®å¯„ã› */
        }
        #hiraganaDisplay {
            font-size: 20px;
            color: black;
            height: 55px; /* ã²ã‚‰ãŒãªã‚¨ãƒªã‚¢ã®é«˜ã•å›ºå®š */
            display: flex;
            align-items: flex-start; /* ç¸¦æ–¹å‘ã‚’ä¸Šå¯„ã› */
            justify-content: center; /* æ¨ªæ–¹å‘ã®ä¸­å¤®å¯„ã› */
            text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­å¤®å¯„ã› */
        }
        /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠ */
        #keyboard {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        /* å„è¡Œï¼ˆæ¨ªä¸¦ã³ï¼‰ */
        #keyboard .row {
            display: flex;
            gap: 5px;
        }

        /* å„ã‚­ãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #keyboard .key {
            width: 27px;
            height: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid black;
            border-radius: 3px;
            background-color: white;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s, transform 0.1s;
        }

        #keyboard .key.home {
            border: 1px solid red; /* èµ¤è‰²ã®æ ç·š */
        }

        /* æ¬¡ã«æŠ¼ã™ã‚­ãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        #keyboard .key.active {
            background-color: #ff5722;
            transform: scale(1.1);
        }

        #keyboard .row:nth-child(2) { /* 2æ®µç›®ã‚’åŠã‚­ãƒ¼åˆ†ãšã‚‰ã™ */
            margin-left: 25px;
        }
        #keyboard .row:nth-child(3) { /* 3æ®µç›®ã‚’1/4ã‚­ãƒ¼åˆ†ãšã‚‰ã™ */
            margin-left: 40px;
        }
        #keyboard .row:nth-child(4) { /* 4æ®µç›®ã‚’åŠã‚­ãƒ¼åˆ†ãšã‚‰ã™ */
            margin-left: 60px;
        }
        #handsContainer {
            display: none;
            justify-content: space-around; /* å·¦å³ã«åˆ†ã‘ã‚‹ */
            width: 350px; /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å¹…ã«åˆã‚ã›ã¦å°ã•ãã™ã‚‹ */
            height: 60px; /* ä¸è¦ãªä½™ç™½ã‚’å‰Šæ¸› */
            margin-top: -0;
            margin-left: 135px;
        }


        .finger {
            fill: lightgray; /* æŒ‡ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰² */
            stroke: black;
            stroke-width: 2;
            transition: fill 0.2s;
        }

        .finger.active {
            fill: #ff5722; /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­ã®æŒ‡ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«ã™ã‚‹ */
        }



    </style>
</head>
<body>
    <p id="select">ã‚‚ã‚“ã ã„ã®ã‚€ãšã‹ã—ã•ã‚’ãˆã‚‰ã‚“ã§ã­</p>
    <div id="gradeButtons">
        <button class="gradeButton" data-grade="1">ï¼‘ã­ã‚“ã›ã„</button>
        <button class="gradeButton" data-grade="2">ï¼’ã­ã‚“ã›ã„</button>
        <button class="gradeButton" data-grade="3">ï¼“å¹´ç”Ÿ</button>
        <button class="gradeButton" data-grade="4">ï¼”å¹´ç”Ÿ</button>
        <button class="gradeButton" data-grade="5">ï¼•å¹´ç”Ÿ</button>
        <button class="gradeButton" data-grade="6">ï¼–å¹´ç”Ÿ</button>
    </div>
    <p id="startMessage" style="display: none; font-size: 18px; margin-top: 30px;">ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã¯ã˜ã‚ã‚‹</p>
    <div id="wordContainer">
        <div id="kanjiDisplay"></div>
        <div id="hiraganaDisplay"></div>
    </div>
    <p class="romaji" id="romajiDisplay"></p>
    <div id="keyboard" class="keyboard">
    <div class="row">
        <div class="key" id="key1">1</div>
        <div class="key" id="key2">2</div>
        <div class="key" id="key3">3</div>
        <div class="key" id="key4">4</div>
        <div class="key" id="key5">5</div>
        <div class="key" id="key6">6</div>
        <div class="key" id="key7">7</div>
        <div class="key" id="key8">8</div>
        <div class="key" id="key9">9</div>
        <div class="key" id="key0">0</div>
        <div class="key" id="key-">-</div>
    </div>
    <div class="row">
        <div class="key" id="keyQ">Q</div>
        <div class="key" id="keyW">W</div>
        <div class="key" id="keyE">E</div>
        <div class="key" id="keyR">R</div>
        <div class="key" id="keyT">T</div>
        <div class="key" id="keyY">Y</div>
        <div class="key" id="keyU">U</div>
        <div class="key" id="keyI">I</div>
        <div class="key" id="keyO">O</div>
        <div class="key" id="keyP">P</div>
        <div class="key" id="key@">@</div>
    </div>
    <div class="row">
        <div class="key home" id="keyA">A</div>
        <div class="key home" id="keyS">S</div>
        <div class="key home" id="keyD">D</div>
        <div class="key home" id="keyF">F</div>
        <div class="key" id="keyG">G</div>
        <div class="key" id="keyH">H</div>
        <div class="key home" id="keyJ">J</div>
        <div class="key home" id="keyK">K</div>
        <div class="key home" id="keyL">L</div>
        <div class="key home" id="keySemicolon">;</div>
        <div class="key" id="keycolon">:</div>
    </div>
        <div class="row">
        <div class="key" id="keyZ">Z</div>
        <div class="key" id="keyX">X</div>
        <div class="key" id="keyC">C</div>
        <div class="key" id="keyV">V</div>
        <div class="key" id="keyB">B</div>
        <div class="key" id="keyN">N</div>
        <div class="key" id="keyM">M</div>
        <div class="key" id="key,">,</div>
        <div class="key" id="key.">.</div>
        <div class="key" id="key/">/</div>
        <div class="key" id="key\">\</div>
    </div>
    </div>
<div id="handsContainer">
<svg id="hands" viewBox="0 0 390 60" width="390" height="60">
    <!-- å·¦æ‰‹ -->
<g id="leftHand" transform="translate(50, -10)">
    <rect class="finger" id="finger-L5" x="-20" y="50" width="20" height="30" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-L4" x="10" y="35" width="20" height="45" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-L3" x="40" y="25" width="20" height="55" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-L2" x="70" y="45" width="20" height="35" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-L1" x="100" y="63" width="20" height="20" rx="10" ry="10" stroke="black" stroke-width="2"/>
</g>

<g id="rightHand" transform="translate(320, -10) scale(-1, 1)">
    <rect class="finger" id="finger-R5" x="-20" y="50" width="20" height="30" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-R4" x="10" y="35" width="20" height="45" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-R3" x="40" y="25" width="20" height="55" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-R2" x="70" y="45" width="20" height="35" rx="10" ry="10" stroke="black" stroke-width="2"/>
    <rect class="finger" id="finger-R1" x="100" y="63" width="20" height="20" rx="10" ry="10" stroke="black" stroke-width="2"/>
</g>

</svg>

</div>

    <p id="result"></p>


    <script>
        let questions = []; // å•é¡Œãƒªã‚¹ãƒˆ
        let remainingQuestions = []; // **ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œç”¨ï¼ˆã“ã“ã‹ã‚‰å‰Šé™¤ã™ã‚‹ï¼‰**
        let currentQuestion = {}; // ç¾åœ¨ã®å•é¡Œ
        let currentIndex = 0;
        let questionCount = 0; // å‡ºé¡Œã‚«ã‚¦ãƒ³ãƒˆ
        let currentAnswerList = []; // ç¾åœ¨ã®å›ç­”ãƒªã‚¹ãƒˆï¼ˆè¤‡æ•°ã®æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        const maxQuestions = 8; // å‡ºé¡Œã™ã‚‹å•é¡Œæ•°
        let currentDisplayedRomaji = ""; // **ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ­ãƒ¼ãƒå­—ã‚’ä¿æŒã™ã‚‹å¤‰æ•°**
        let totalKeysPressed = 0;  // æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã®ç·æ•°ï¼ˆæ­£è§£ï¼‹ãƒŸã‚¹ï¼‰
        let correctKeysPressed = 0; // æ­£ã—ãæ‰“ã£ãŸã‚­ãƒ¼ã®æ•°
        let mistakeCount = 0;  // ãƒŸã‚¹ã—ãŸã‚­ãƒ¼ã®æ•°
        let startTime = 0;  // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“ï¼ˆUNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
        let endTime = 0;  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚é–“
        let selectedGrade = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1å¹´ç”Ÿã«è¨­å®š
        
        // ã²ã‚‰ãŒãª â†’ ãƒ­ãƒ¼ãƒå­—å¤‰æ›è¡¨
        // åŸºæœ¬ã®ã€Œã²ã‚‰ãŒãª â†’ ãƒ­ãƒ¼ãƒå­—ã€ãƒãƒƒãƒ”ãƒ³ã‚°
        const hiraToRoma = {
            "ã‚": ["a"], "ã„": ["i"], "ã†": ["u"], "ãˆ": ["e"], "ãŠ": ["o"],
            "ã‹": ["ka"], "ã": ["ki"], "ã": ["ku"], "ã‘": ["ke"], "ã“": ["ko"],
            "ã•": ["sa"], "ã—": ["si", "shi"], "ã™": ["su"], "ã›": ["se"], "ã": ["so"],
            "ãŸ": ["ta"], "ã¡": ["ti", "chi"], "ã¤": ["tu", "tsu"], "ã¦": ["te"], "ã¨": ["to"],
            "ãª": ["na"], "ã«": ["ni"], "ã¬": ["nu"], "ã­": ["ne"], "ã®": ["no"],
            "ã¯": ["ha"], "ã²": ["hi"], "ãµ": ["hu", "fu"], "ã¸": ["he"], "ã»": ["ho"],
            "ã¾": ["ma"], "ã¿": ["mi"], "ã‚€": ["mu"], "ã‚": ["me"], "ã‚‚": ["mo"],
            "ã‚„": ["ya"], "ã‚†": ["yu"], "ã‚ˆ": ["yo"],
            "ã‚‰": ["ra"], "ã‚Š": ["ri"], "ã‚‹": ["ru"], "ã‚Œ": ["re"], "ã‚": ["ro"],
            "ã‚": ["wa"], "ã‚’": ["wo"], "ã‚“": ["n", "nn"],

            // æ¿éŸ³
            "ãŒ": ["ga"], "ã": ["gi"], "ã": ["gu"], "ã’": ["ge"], "ã”": ["go"],
            "ã–": ["za"], "ã˜": ["ji", "zi"], "ãš": ["zu"], "ãœ": ["ze"], "ã": ["zo"],
            "ã ": ["da"], "ã¢": ["di"], "ã¥": ["du"], "ã§": ["de"], "ã©": ["do"],
            "ã°": ["ba"], "ã³": ["bi"], "ã¶": ["bu"], "ã¹": ["be"], "ã¼": ["bo"],
            "ã±": ["pa"], "ã´": ["pi"], "ã·": ["pu"], "ãº": ["pe"], "ã½": ["po"],

            // å°ã•ã„ã€Œã£ã€
            "ã£": ["ltu", "xtu"],

            // **æ•°å­—ã®å¯¾å¿œã‚’è¿½åŠ **
            "ï¼": ["0"], "ï¼‘": ["1"], "ï¼’": ["2"], "ï¼“": ["3"], "ï¼”": ["4"],
            "ï¼•": ["5"], "ï¼–": ["6"], "ï¼—": ["7"], "ï¼˜": ["8"], "ï¼™": ["9"],

            // é•·éŸ³ï¼ˆãƒ¼ï¼‰ã¯ã€Œ-ã€ã®ã¿ã«ã™ã‚‹
            "ãƒ¼": ["-"], "ã€‚": ["."], "ã€": [","],

            // **ã€Œã‚ƒã‚…ã‚‡ã€ã®å¤‰æ›ã‚’çµ±åˆ**
            "ãã‚ƒ": ["kya"], "ãã‚…": ["kyu"], "ãã‚‡": ["kyo"],
            "ã—ã‚ƒ": ["sya", "sha", "silya"], "ã—ã‚…": ["syu", "shu", "silyu"], "ã—ã‚‡": ["syo", "sho", "silyo"],
            "ã¡ã‚ƒ": ["tya", "cha"], "ã¡ã‚…": ["tyu", "chu"], "ã¡ã‚‡": ["tyo", "cho"],
            "ã«ã‚ƒ": ["nya"], "ã«ã‚…": ["nyu"], "ã«ã‚‡": ["nyo"],
            "ã²ã‚ƒ": ["hya"], "ã²ã‚…": ["hyu"], "ã²ã‚‡": ["hyo"],
            "ã¿ã‚ƒ": ["mya"], "ã¿ã‚…": ["myu"], "ã¿ã‚‡": ["myo"],
            "ã‚Šã‚ƒ": ["rya"], "ã‚Šã‚…": ["ryu"], "ã‚Šã‚‡": ["ryo"],
            "ãã‚ƒ": ["gya"], "ãã‚…": ["gyu"], "ãã‚‡": ["gyo"],
            "ã˜ã‚ƒ": ["zya", "ja"], "ã˜ã‚…": ["zyu", "ju"], "ã˜ã‚‡": ["zyo", "jo"],
            "ã³ã‚ƒ": ["bya"], "ã³ã‚…": ["byu"], "ã³ã‚‡": ["byo"],
            "ã´ã‚ƒ": ["pya"], "ã´ã‚…": ["pyu"], "ã´ã‚‡": ["pyo"],
            "ã¦ãƒ": ["thi"], "ã§ãƒ": ["dhi"], "ã§ã‚…": ["dhu"],
            "ãµã": ["fa"], "ãµãƒ": ["fi"], "ãµã‚…": ["fyu"], "ãµã‡": ["fe"], "ãµã‰": ["fo"],

            // å°æ›¸ãã€Œã‚ƒã‚…ã‚‡ã€ã‚’çµ±åˆï¼ˆã€Œlyaã€ã€Œxyaã€å¯¾å¿œï¼‰
            "ã‚ƒ": ["ya", "lya", "xya"], "ã‚…": ["yu", "lyu", "xyu"], "ã‚‡": ["yo", "lyo", "xyo"]
        };

        const keyToFinger = {
            "1": "L5", "2": "L5", "Q": "L5", "A": "L5", "Z": "L5",
            "3": "L4", "W": "L4", "S": "L4", "X": "L4",
            "4": "L3", "E": "L3", "D": "L3", "C": "L3",
            "5": "L2", "R": "L2", "F": "L2", "V": "L2", "T": "L2", "G": "L2", "B": "L2",
            " ": "L1", // ã‚¹ãƒšãƒ¼ã‚¹ãƒãƒ¼

            "6": "R2", "Y": "R2", "H": "R2", "N": "R2", "7": "R2", "U": "R2", "J": "R2", "M": "R2",
            "8": "R3", "I": "R3", "K": "R3", ",": "R3",
            "9": "R4", "O": "R4", "L": "R4", ".": "R4",
            "0": "R5", "P": "R5", ";": "R5", "/": "R5", "-": "R5", "@": "R5"
        };

        function setGrade(grade) {
            selectedGrade = grade; // é¸æŠã•ã‚ŒãŸå­¦å¹´ã‚’æ ¼ç´
            loadQuestions(); // JSONã‚’ãƒ­ãƒ¼ãƒ‰
        }

        async function loadQuestions() {
            const fileName = `questions_${selectedGrade}.json`; // å­¦å¹´ã«å¿œã˜ãŸãƒ•ã‚¡ã‚¤ãƒ«å
            try {
                const response = await fetch(fileName);
                questions = await response.json();
                console.log(`JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº† (${fileName}):`, questions);
            } catch (error) {
                console.error("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            }
        }
function calculateScore() {

    endTime = Date.now();
    console.log("ãƒŸã‚¹ãƒ†ã‚¤ã‚¯ã‚«ã‚¦ãƒ³ãƒˆ:", mistakeCount);
    
    // **çµŒéæ™‚é–“ (ç§’) ã‚’è¨ˆç®—**
    let elapsedTime = (endTime - startTime) / 1000;
    elapsedTime = Math.max(1, elapsedTime); // **è² ã®å€¤ã‚„0ã‚’é˜²ã**
    console.log("çµŒéç§’æ•°:", elapsedTime);

    // **æ­£ç¢ºæ€§ã‚’è¨ˆç®—**
    let accuracy = (correctKeysPressed / totalKeysPressed) * 100;
    accuracy = isNaN(accuracy) ? 0 : parseFloat(accuracy.toFixed(2));
    console.log("æ­£ç¢ºæ€§:", accuracy);

    // **ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è¨ˆç®— (1åˆ†ã‚ãŸã‚Šã®ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—æ•°)**
    let keySpeed = (correctKeysPressed / elapsedTime)* 50;
    keySpeed = isNaN(keySpeed) ? 0 : parseFloat(keySpeed.toFixed(2));
    console.log("ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰:", keySpeed);

    // **ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã®å½±éŸ¿ã‚’èª¿æ•´**
    let adjustedMistake = mistakeCount * 8;  // ãƒŸã‚¹ã®å½±éŸ¿ã‚’å¢—ã‚„ã™

    // **ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å½±éŸ¿ã‚’èª¿æ•´**
    let adjustedSpeed = Math.pow(keySpeed / 10, 1.2) * 50; // **ã‚ˆã‚Šå½±éŸ¿ã‚’å¼·ã‚ã‚‹**

    // **ã‚¹ã‚³ã‚¢ã®è¨ˆç®—**
    let rawScore = Math.round(accuracy + adjustedSpeed - adjustedMistake);

    // **ã‚¹ã‚³ã‚¢ã®è£œæ­£**
    let score = Math.max(0, Math.round(rawScore / 8)); 
    
    // **ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°**
    console.log("ãƒŸã‚¹ãƒ†ã‚¤ã‚¯ã®å½±éŸ¿:", adjustedMistake);
    console.log("ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å½±éŸ¿:", adjustedSpeed);
    console.log("ç”Ÿã‚¹ã‚³ã‚¢:", rawScore);
    console.log("æœ€çµ‚ã‚¹ã‚³ã‚¢:", score);

    // **ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º**
    document.getElementById("result").innerHTML = `
        ğŸ¯ æ­£ç¢ºæ€§: ${accuracy}% <br>
        âš¡ ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰: ${keySpeed} å›/åˆ† <br>
        ğŸ† ã‚¹ã‚³ã‚¢: ${score}
    `;
}

        // ã²ã‚‰ãŒãªã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›
        function convertToRomaji(hiragana) {
            console.log("å¤‰æ›é–‹å§‹: ", hiragana);
            let romajiList = [""];

            for (let i = 0; i < hiragana.length; i++) {
                const char = hiragana[i];

                // **ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯**
                if (!hiraToRoma[char]) {
                    console.warn("å¤‰æ›ã§ããªã„æ–‡å­—:", char);
                    continue;
                }

                let newRomajiList = [];

                // **ã€Œã—ã‚…ã€ã€Œã—ã‚ƒã€ã€Œã—ã‚‡ã€ãªã©ã®2æ–‡å­—ã‚’æœ€åˆã«å‡¦ç†**
                if (i < hiragana.length - 1) {
                    let combinedChar = char + hiragana[i + 1];
                    if (hiraToRoma[combinedChar]) {
                        let sortedVariants = [...hiraToRoma[combinedChar]];
                        sortedVariants.sort((a, b) => a.length - b.length); // çŸ­ã„ã‚‚ã®ã‚’å„ªå…ˆ

                        for (const prefix of romajiList) {
                            for (const variant of sortedVariants) {
                                newRomajiList.push(prefix + variant);
                            }
                        }
                        romajiList = newRomajiList;
                        i++; // 2æ–‡å­—ã‚’å‡¦ç†ã—ãŸã®ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—
                        continue;
                    }
                }

                // **ã€Œã£ã€ã®å‡¦ç†ï¼ˆå­éŸ³é‡ã­ã‚’æœ€å„ªå…ˆï¼‰**
                if (char === "ã£") {
                    let sortedVariants = [];

                    // **æ¬¡ã®æ–‡å­—ãŒå­éŸ³ãªã‚‰ã€å­éŸ³ã‚’é‡ã­ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æœ€å„ªå…ˆ**
                    if (i + 1 < hiragana.length) {
                        let nextChar = hiraToRoma[hiragana[i + 1]];
                        if (nextChar) {
                            let consonant = nextChar[0].charAt(0);
                            if (consonant.match(/[bcdfghjklmnpqrstvwxyz]/)) {
                                sortedVariants.push(consonant); // å­éŸ³ã‚’é‡ã­ã‚‹
                            }
                        }
                    }

                    // **ã€Œltuã€ã€Œxtuã€ã‚’å¾Œå›ã—ã«ã™ã‚‹**
                    sortedVariants.push(...hiraToRoma["ã£"]);

                    for (const prefix of romajiList) {
                        for (const variant of sortedVariants) {
                            newRomajiList.push(prefix + variant);
                        }
                    }

                    romajiList = newRomajiList;
                    continue;
                }

                // **é€šå¸¸ã®ã²ã‚‰ãŒãªã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›**
                let sortedVariants = [...hiraToRoma[char]];
                sortedVariants.sort((a, b) => a.length - b.length); // çŸ­ã„ã‚‚ã®ã‚’å„ªå…ˆ

                for (const prefix of romajiList) {
                    for (const variant of sortedVariants) {
                        newRomajiList.push(prefix + variant);
                    }
                }
                romajiList = newRomajiList;
            }

            console.log("å¤‰æ›çµæœ: ", romajiList);
            return romajiList;
        }

        function highlightNextKey() {
            console.log("ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ã‚­ãƒ¼:", currentDisplayedRomaji, "ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", currentIndex); // **ãƒ‡ãƒãƒƒã‚°ç”¨**
            // ã¾ãšã€å‰ã®ã‚­ãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
            const previousKey = document.querySelector(".key.active");
            if (previousKey) {
                previousKey.classList.remove("active");
            }

            // æ¬¡ã«æŠ¼ã™ã¹ãã‚­ãƒ¼ã‚’å–å¾—
            const nextKey = currentDisplayedRomaji[currentIndex];
            if (!nextKey) {
                console.warn("æ¬¡ã®ã‚­ãƒ¼ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:", currentDisplayedRomaji, currentIndex); // **ãƒ‡ãƒãƒƒã‚°**
                return;
            }

            // å¯¾å¿œã™ã‚‹ã‚­ãƒ¼ã®è¦ç´ ã‚’å–å¾—ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const keyElement = document.getElementById(`key${nextKey.toUpperCase()}`);
            if (keyElement) {
                keyElement.classList.add("active");
            }
            highlightFinger(nextKey); // æŒ‡ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        }

        function highlightFinger(key) {
            const fingerId = keyToFinger[key.toUpperCase()];
            if (!fingerId) return;
            console.log("æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼:", key); //ãƒ‡ãƒãƒƒã‚°
            console.log("å¯¾å¿œã™ã‚‹æŒ‡ã®ID:", fingerId); //ãƒ‡ãƒãƒƒã‚°

            // ã™ã¹ã¦ã®æŒ‡ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
            document.querySelectorAll(".finger").forEach(finger => {
                finger.classList.remove("active");
            });

            // æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹æŒ‡ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const fingerElement = document.getElementById(`finger-${fingerId}`);
            console.log("å–å¾—ã•ã‚ŒãŸ fingerId:", fingerId); //ãƒ‡ãƒãƒƒã‚°
            console.log("æ¤œç´¢ã™ã‚‹è¦ç´ ID:", `finger-${fingerId}`); //ãƒ‡ãƒãƒƒã‚°

            if (fingerElement) {
                fingerElement.classList.add("active");
            }
        }
        
        // å•é¡Œã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function setRandomQuestion() {
            if (questionCount >= maxQuestions || remainingQuestions.length === 0) {
                document.getElementById("result").textContent = "çµ‚äº†ï¼";

                // **2ç§’å¾Œã«ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º**
                setTimeout(() => {
                    calculateScore(); // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼†è¡¨ç¤º
                }, 2000); // **2ç§’ (2000ãƒŸãƒªç§’) å¾…ã¤**
                return;
            }

            currentIndex = 0;
            let randomIndex = Math.floor(Math.random() * remainingQuestions.length);
            currentQuestion = remainingQuestions[randomIndex];
            // **å‡ºé¡Œæ¸ˆã¿ã®å•é¡Œã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤**
            remainingQuestions.splice(randomIndex, 1);
            questionCount++;

            console.log("é¸ã°ã‚ŒãŸå•é¡Œ:", currentQuestion); // ãƒ‡ãƒãƒƒã‚°ç”¨ã€€å¾Œã§æ¶ˆã™

            if (!currentQuestion.hiragana) {
                console.error("ã‚¨ãƒ©ãƒ¼: hiragana ã®å€¤ãŒ undefined ã§ã™", currentQuestion);
                return;
            }

            // **Båˆ—ï¼ˆã²ã‚‰ãŒãªï¼‰ã®ã¿ã‚’ãƒ­ãƒ¼ãƒå­—å¤‰æ›**
            currentAnswerList = convertToRomaji(currentQuestion.hiragana);

            if (currentAnswerList.length > 0) {
                currentDisplayedRomaji = currentAnswerList[0];
            } else {
                console.error("ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ãƒå­—å¤‰æ›çµæœãŒç©ºã§ã™", currentQuestion.hiragana);
                return;
            }

            // **æ¼¢å­—äº¤ã˜ã‚Šã®æ–‡ã‚’å¤§ããã€ã²ã‚‰ãŒãªã‚’ãã®ä¸‹ã«è¡¨ç¤º**
            document.getElementById("kanjiDisplay").innerHTML = `<span>${currentQuestion.kanji}</span>`;
            document.getElementById("hiraganaDisplay").innerHTML = `<span>${currentQuestion.hiragana}</span>`;

            document.getElementById("romajiDisplay").innerHTML = currentAnswerList[0]
                .split("")
                .map(letter => `<span>${letter.toUpperCase()}</span>`)
                .join("");

            document.getElementById("result").textContent = "";

            highlightNextKey(); 
        }
        
        // **ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’é–¢æ•°åŒ–**
        async function startGame() {
            // **JSONã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤**
            if (!questions || questions.length === 0) {
                await loadQuestions();
            }
            let keyboard = document.getElementById("keyboard");
    
            if (keyboard) {
                keyboard.style.display = "flex"; // **ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã‚’é©ç”¨**
            } else {
                console.error("ã‚¨ãƒ©ãƒ¼: keyboard ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
            }

            document.getElementById("wordContainer").style.display = "block";
            document.getElementById("romajiDisplay").style.display = "block";
            document.getElementById("handsContainer").style.display = "block";
            document.getElementById("result").style.display = "block";

            // **ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ**
            totalKeysPressed = 0;
            correctKeysPressed = 0;
            mistakeCount = 0;
            startTime = Date.now(); // **ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²**

            remainingQuestions = [...questions];

            setRandomQuestion();
        }

        // **å­¦å¹´é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç†**
        document.querySelectorAll(".gradeButton").forEach(button => {
            button.addEventListener("click", function() {
                selectedGrade = this.getAttribute("data-grade"); // é¸æŠã•ã‚ŒãŸå­¦å¹´ã‚’å–å¾—
                document.getElementById("gradeButtons").style.display = "none"; // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                document.getElementById("select").style.display = "none"; // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                document.getElementById("startMessage").style.display = "block"; // ã€Œã‚¹ãƒšãƒ¼ã‚¹ or ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§é–‹å§‹ã€ã®è¡¨ç¤º

                // **ã‚¨ãƒ³ã‚¿ãƒ¼ or ã‚¹ãƒšãƒ¼ã‚¹ã§é–‹å§‹**
                document.addEventListener("keydown", startOnKeyPress);
            });
        });

        function startOnKeyPress(event) {
            if (event.key === "Enter" || event.key === " ") { // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¯ " " (åŠè§’ã‚¹ãƒšãƒ¼ã‚¹)
                document.getElementById("startMessage").style.display = "none"; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                document.removeEventListener("keydown", startOnKeyPress); // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è§£é™¤
                startGame(); // ã‚²ãƒ¼ãƒ é–‹å§‹
            }
        }

document.addEventListener("keydown", function(event) {
    if (!currentAnswerList || currentAnswerList.length === 0) return;
    if (currentIndex >= Math.max(...currentAnswerList.map(answer => answer.length))) return;

    const key = event.key.toLowerCase();
    totalKeysPressed++; // **æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ç·æ•°ã‚’å¢—ã‚„ã™**
    let newAnswerList = [];
    let matched = false; // **ã‚­ãƒ¼ãŒãƒãƒƒãƒã—ãŸã‹ã‚’ç¢ºèª**

    // **ç¾åœ¨ã®å…¥åŠ›ã«é©ã—ãŸãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º**
    for (let option of currentAnswerList) {
        if (option.startsWith(option.substring(0, currentIndex) + key)) {
            newAnswerList.push(option);
            matched = true; // **ãƒãƒƒãƒã—ãŸå ´åˆã¯ true ã«ã™ã‚‹**
        }
    }

    if (matched) {
        correctKeysPressed++; // **æ­£ã—ãå…¥åŠ›ã—ãŸã‚­ãƒ¼æ•°ã‚’å¢—ã‚„ã™**
        currentAnswerList = newAnswerList; // **å…¥åŠ›ã«é©ã—ãŸã‚‚ã®ã ã‘ã‚’æ®‹ã™**
        currentDisplayedRomaji = newAnswerList[0]; // **ç¾åœ¨ã®è¡¨ç¤ºãƒ­ãƒ¼ãƒå­—ã‚’æ›´æ–°**
        console.log("æ­£è§£ã—ãŸã‚­ãƒ¼æ•°:", correctKeysPressed); // **ãƒ‡ãƒãƒƒã‚°ç”¨**
        
        let spans = document.getElementById("romajiDisplay").getElementsByTagName("span");

        if (spans[currentIndex]) {
            spans[currentIndex].classList.add("correct");
        }

        currentIndex++;

        highlightNextKey(); // æ¬¡ã«å…¥åŠ›ã™ã‚‹ã‚­ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

        // **è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«åˆã‚ã›ãŸãƒ­ãƒ¼ãƒå­—ã‚’åæ˜ ï¼‰**
        document.getElementById("romajiDisplay").innerHTML = currentDisplayedRomaji
            .split("")
            .map((letter, index) => `<span class="${index < currentIndex ? 'correct' : ''}">${letter.toUpperCase()}</span>`)
            .join("");

        // **ã‚¯ãƒªã‚¢åˆ¤å®šï¼šã€Œç¾åœ¨ã®è¡¨ç¤ºãƒ­ãƒ¼ãƒå­—ã®æœ€å¾Œã®æ–‡å­—ãŒå…¥åŠ›ã•ã‚ŒãŸã‹ï¼Ÿã€**
        if (currentIndex === currentDisplayedRomaji.length) {
            setRandomQuestion();
            currentDisplayedRomaji = ""; // **æ¬¡ã®å•é¡Œã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ**
        }
    } else {
        // **ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã€ãƒŸã‚¹ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™**
        mistakeCount++;
        console.log("ãƒŸã‚¹ã—ãŸã‚­ãƒ¼æ•°:", mistakeCount); // **ãƒ‡ãƒãƒƒã‚°ç”¨**
    }
});

    </script>
</body>
</html>
