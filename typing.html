<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイピングゲーム</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .word, .romaji, #result, #questionCounter {
            font-size: 28px;
            margin: 20px 0;
            display: none;
        }
        .romaji span {
            letter-spacing: 5px;
        }
        .correct {
            color: green;
        }
        #startButton {
            font-size: 24px;
            padding: 10px 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>タイピングゲーム</h2>
    
    <button id="startButton">スタート</button>

    <p class="word" id="wordDisplay"></p>
    <p class="romaji" id="romajiDisplay"></p>
    <p id="result"></p>
    <p id="questionCounter"></p>

    <script>
        let questions = []; // 問題リスト
        let currentQuestion = {}; // 現在の問題
        let currentIndex = 0;
        let questionCount = 0; // 出題カウント
        let currentAnswerList = []; // 現在の回答リスト（複数の正解パターン）
        const maxQuestions = 3; // 出題する問題数

        // ひらがな → ローマ字変換表
// 基本の「ひらがな → ローマ字」マッピング
const hiraToRoma = {
    "あ": ["a"], "い": ["i"], "う": ["u"], "え": ["e"], "お": ["o"],
    "か": ["ka"], "き": ["ki"], "く": ["ku"], "け": ["ke"], "こ": ["ko"],
    "さ": ["sa"], "し": ["si", "shi"], "す": ["su"], "せ": ["se"], "そ": ["so"],
    "た": ["ta"], "ち": ["ti", "chi"], "つ": ["tu", "tsu"], "て": ["te"], "と": ["to"],
    "な": ["na"], "に": ["ni"], "ぬ": ["nu"], "ね": ["ne"], "の": ["no"],
    "は": ["ha"], "ひ": ["hi"], "ふ": ["hu", "fu"], "へ": ["he"], "ほ": ["ho"],
    "ま": ["ma"], "み": ["mi"], "む": ["mu"], "め": ["me"], "も": ["mo"],
    "や": ["ya"], "ゆ": ["yu"], "よ": ["yo"],
    "ら": ["ra"], "り": ["ri"], "る": ["ru"], "れ": ["re"], "ろ": ["ro"],
    "わ": ["wa"], "を": ["wo"], "ん": ["n", "nn"],

    // 濁音
    "が": ["ga"], "ぎ": ["gi"], "ぐ": ["gu"], "げ": ["ge"], "ご": ["go"],
    "ざ": ["za"], "じ": ["zi", "ji"], "ず": ["zu"], "ぜ": ["ze"], "ぞ": ["zo"],
    "だ": ["da"], "ぢ": ["di"], "づ": ["du"], "で": ["de"], "ど": ["do"],
    "ば": ["ba"], "び": ["bi"], "ぶ": ["bu"], "べ": ["be"], "ぼ": ["bo"],

    // 半濁音
    "ぱ": ["pa"], "ぴ": ["pi"], "ぷ": ["pu"], "ぺ": ["pe"], "ぽ": ["po"],

    // 小さい「っ」
    "っ": ["ltu", "xtu"],

    // 長音（ー）は「-」のみにする
    "ー": ["-"]
};

// **「ゃゅょ」の特別な変換を追加**
Object.assign(hiraToRoma, {
    "きゃ": ["kya"], "きゅ": ["kyu"], "きょ": ["kyo"],
    "しゃ": ["sya", "sha"], "しゅ": ["syu", "shu"], "しょ": ["syo", "sho"],
    "ちゃ": ["tya", "cha"], "ちゅ": ["tyu", "chu"], "ちょ": ["tyo", "cho"],
    "にゃ": ["nya"], "にゅ": ["nyu"], "にょ": ["nyo"],
    "ひゃ": ["hya"], "ひゅ": ["hyu"], "ひょ": ["hyo"],
    "みゃ": ["mya"], "みゅ": ["myu"], "みょ": ["myo"],
    "りゃ": ["rya"], "りゅ": ["ryu"], "りょ": ["ryo"],
    "ぎゃ": ["gya"], "ぎゅ": ["gyu"], "ぎょ": ["gyo"],
    "じゃ": ["zya", "ja"], "じゅ": ["zyu", "ju"], "じょ": ["zyo", "jo"],
    "びゃ": ["bya"], "びゅ": ["byu"], "びょ": ["byo"],
    "ぴゃ": ["pya"], "ぴゅ": ["pyu"], "ぴょ": ["pyo"]
});

// **小さい「ゃゅょ」の「lya」「xya」対応**
Object.assign(hiraToRoma, {
    "ゃ": ["ya", "lya", "xya"], "ゅ": ["yu", "lyu", "xyu"], "ょ": ["yo", "lyo", "xyo"]
});

        // 小文字「ゃゅょ」の変換（「lya」「xya」に対応）
        const smallKana = {
            "ゃ": ["ya", "lya", "xya"], "ゅ": ["yu", "lyu", "xyu"], "ょ": ["yo", "lyo", "xyo"]
        };




        // JSONファイルを読み込む
        async function loadQuestions() {
            const response = await fetch("questions.json");
            questions = await response.json();
        }

        // ひらがなをローマ字に変換
function convertToRomaji(hiragana) {
    console.log("変換開始: ", hiragana); // どんなデータが渡されているかチェック
    let romajiList = [""];
    for (let i = 0; i < hiragana.length; i++) {
        const char = hiragana[i];

                // **デバッグログを追加**
        if (!hiraToRoma[char]) {
            console.warn("変換できない文字:", char); // どの文字でエラーが出るのか確認
            continue; // 変換できない文字はスキップ
        }

        // 「っ」の処理（単独「ltu」「xtu」 or 次の子音を重ねる）
        if (char === "っ") {
            let newRomajiList = [];

            // 「ltu」「xtu」単独入力パターンを追加
            for (const prefix of romajiList) {
                for (const variant of hiraToRoma["っ"]) {
                    newRomajiList.push(prefix + variant);
                }
            }

            // 次の文字が子音なら、子音を重ねるパターンを追加
            if (i + 1 < hiragana.length) {
                let nextChar = hiraToRoma[hiragana[i + 1]];
                if (nextChar) {
                    let consonant = nextChar[0].charAt(0); // 次の文字の先頭の子音を取得
                    if (consonant.match(/[bcdfghjklmnpqrstvwxyz]/)) {
                        for (const prefix of romajiList) {
                            newRomajiList.push(prefix + consonant);
                        }
                    }
                }
            }

            romajiList = newRomajiList;
            continue;
        }

        // **「しゃ、しゅ、しょ」の処理（し＋ゃゅょを特別処理）**
        if (i > 0) {
            let prevChar = hiragana[i - 1] + char; // 例: 「し」+「ゃ」=「しゃ」
            if (hiraToRoma[prevChar]) {
                let newRomajiList = [];
                for (const prefix of romajiList) {
                    for (const variant of hiraToRoma[prevChar]) {
                        newRomajiList.push(prefix.slice(0, -1) + variant); // 「し」を削除し、「しゃ」にする
                    }
                }
                romajiList = newRomajiList;
                continue;
            }
        }

        // **「ゃゅょ」の処理（単独「lya」「xya」対応）**
        if (smallKana[char]) {
            let newRomajiList = [];
            for (const prefix of romajiList) {
                for (const variant of smallKana[char]) {
                    newRomajiList.push(prefix + variant);
                }
            }
            romajiList = newRomajiList;
            continue;
        }

        // **通常のひらがなをローマ字に変換**
        if (hiraToRoma[char]) {
            let newRomajiList = [];
            for (const prefix of romajiList) {
                for (const variant of hiraToRoma[char]) {
                    newRomajiList.push(prefix + variant);
                }
            }
            romajiList = newRomajiList;
        }
    }
    console.log("変換結果: ", romajiList);
    return romajiList;
}

async function loadJSON() {
    const response = await fetch("./questions.json");
    questions = await response.json();

    console.log("JSONデータの読み込み完了:", questions);
}

        window.onload = async function() {
    await loadJSON();
    console.log("問題データ:", questions);
};

// 問題をセットする関数を修正
function setRandomQuestion() {
    if (questionCount >= maxQuestions) {
        document.getElementById("result").textContent = "ゲームクリア！";
        return;
    }

    currentIndex = 0;
    currentQuestion = questions[Math.floor(Math.random() * questions.length)];
    questionCount++;

    console.log("選ばれた問題:", currentQuestion); // デバッグ用

        // **エラーの原因がここにある可能性が高い**
    if (!currentQuestion.hiragana) {
        console.error("エラー: hiragana の値が undefined です", currentQuestion);
        return;
    }

    // **B列（ひらがな）のみをローマ字変換**
    currentAnswerList = convertToRomaji(currentQuestion.hiragana);

    // **漢字交じりの文を大きく、ひらがなをその下に表示**
    document.getElementById("wordDisplay").innerHTML = `<span style="font-size: 32px; font-weight: bold;">${currentQuestion.kanji}</span><br><span style="font-size: 24px;">${currentQuestion.hiragana}</span>`;

    document.getElementById("romajiDisplay").innerHTML = currentAnswerList[0]
        .split("")
        .map(letter => `<span>${letter.toUpperCase()}</span>`)
        .join("");

    document.getElementById("result").textContent = "";
}
        // スタートボタンの処理
        document.getElementById("startButton").addEventListener("click", function() {
            document.getElementById("startButton").style.display = "none";
            document.getElementById("wordDisplay").style.display = "block";
            document.getElementById("romajiDisplay").style.display = "block";
            document.getElementById("result").style.display = "block";
            document.getElementById("questionCounter").style.display = "block";

            setRandomQuestion();
        });

        document.addEventListener("keydown", function(event) {
            if (!currentAnswerList || currentAnswerList.length === 0) return; // 問題がセットされていないときは無視
            if (currentIndex >= currentAnswerList[0].length) return; // すでにクリアしていたら無視

            const key = event.key.toLowerCase();
            let matched = false;
            let newAnswer = null; // 更新するための新しいローマ字表記

            // **すべての可能な入力をチェック**
            for (let option of currentAnswerList) {
                if (option.startsWith(currentAnswerList[0].substring(0, currentIndex) + key)) {
                    matched = true;
                    newAnswer = option; // ユーザーの入力に合うパターンを選択
                    break;
                }
            }

            if (matched) {
                currentAnswerList[0] = newAnswer; // 新しいパターンに更新

                // **正しく入力された部分を色変更**
                let spans = document.getElementById("romajiDisplay").getElementsByTagName("span");
                if (spans[currentIndex]) {
                    spans[currentIndex].classList.add("correct");
                }
                currentIndex++;

                // **表示を更新（ユーザーの入力に合わせたローマ字を反映）**
                document.getElementById("romajiDisplay").innerHTML = currentAnswerList[0]
                    .split("")
                    .map((letter, index) => `<span class="${index < currentIndex ? 'correct' : ''}">${letter.toUpperCase()}</span>`)
                    .join("");

                // **すべての文字を入力したら「正解！」を表示**
                let allMatched = currentAnswerList.some(answer => currentIndex === answer.length);
                if (allMatched) {
                    document.getElementById("result").textContent = "正解！";
                    setTimeout(() => {
                        setRandomQuestion(); // **次の問題へ**
                    }, 1000);
                }
            }
        });

    </script>
</body>
</html>
